#!/usr/bin/env python
#
# Simple script for "proofreading" a LaTeX file.
#
# Anders Logg, 2010-12-16

import sys

# FIXME: Add check for . at end of paragraph but not in subsection and section

# List of things to check
checklist = [("i.e.",              "'; that is,'"),
             ("\\cite{",           "\\citet{} or \\citep{}"),
             ("multiindex",        "multi-index"),
             ("multi index",       "multi-index"),
             ("PyDOLFIN",          "DOLFIN"),
             ("editornote",        "fix!"),
             ("authornote",        "fix!"),
             ("displaymath",       "equation"),
             ("equation*",         "equation"),
             ("align*",            "align"),
             ("eqnarray*",         "eqnarray"),
             ("\\forall ",         "\\foralls"),
             ("\\forall\\",        "\\foralls"),
             ("\\geq ",            "\\geqslant"),
             ("\\geq\\",           "\\geqslant"),
             ("\\geq\n",           "\\geqslant"),
             ("\\leq ",            "\\leqslant"),
             ("\\leq\\",           "\\leqslant"),
             ("\\leq\n",           "\\leqslant"),
             ("\\mathcal{T} ",     "\\mathcal{T}_h"),
             ("\\mathcal{T}\\",    "\\mathcal{T}_h"),
             ("commandline",       "command-line"),
             ("command line",      "command-line"),
             ("Nedelec",           "\\nedelec{}"),
             ("etc ",              "etc."),
             ("etc,",              "etc.,"),
             ("cf.",               "see"),
             ("fig.",              "Figure"),
             ("Fig.",              "Figure"),
             ("PyDOLFIN",          "DOLFIN"),
             ("eq.",               ""),
             ("Eq.",               ""),
             ("(\ref{",            "\eqref{}"),
             ("\\begin{code}",     "\begin{python/c++/bash}"),
             (" sub ",             "subfoo"),
             ("Navier-Stokes",      "Navier--Stokes"),
             ("Runge-Kutta",        "Runge--Kutta"),
             ("fluid-structure",    "fluid--structure"),
             ("\\nabla u \\cdot u", "\\nabla u \, u"),
             ("d\Omega",            "\\dx"),
             (" dx",                "\\dx"),
             (" ds",                "\\ds"),
             (" conforming",        "-conforming"),
             ("H(div)",             "$\Hdiv$"),
             ("H(curl)",            "$\Hcurl$")]

# List of words that are allowed to be uppercase in titles
uppercase = ["A",
             "Argyris",
             "Landweber",
             "Laplacian",
             "FEniCS",
             "Lagrange",
             "Crouzeix--Raviart",
             "Raviart--Thomas",
             "Brezzi--Douglas--Marini",
             "Mardal-Tai-Winther",
             "Arnold--Winther",
             "Hermite",
             "Morley",
             "FFC",
             "Navier--Stokes",
             "FErari",
             "Python",
             "UFL",
             "Galerkin",
             "Circle",
             "Willis",
             "PC",
             "MRA",
             "PDEs",
             "Neumann",
             "Poisson",
             "Poisson's",
             "Stokes",
             "Hodge",
             "UFC",
             "XML",
             "DOLFIN",
             "C++/Python",
             "I/O",
             "VTK",
             "Dirichlet",
             "Neumann",
             "Robin",
             "Neumann,",
             "Robin,",
             "Newton",
             "PDE",
             "Poisson-like",
             "Instant",
             "API",
             "C/C++",
             "OpenMP",
             "Orr--Sommerfeld",
             "Gmsh",
             "SAS",
             "Scott--Vogelius",
             "Swiginac",
             "SFC",
             "SFC:",
             "SyFi",
             "Re",
             "ALE",
             "SciPy",
             "Boussinesq",
             "Gaussian",
             "SWIG",
             "Lagrangian",
             "FSI",
             "Earth's"]

def check_capitalization(text):
    warnings = []
    for (i, line) in enumerate(text.split("\n")):
        for section in ("section", "paragraph", "fenicschapter"):
            if ("%s{" % section) in line:
                line = line.split("%s{" % section)[1]
                line = "".join(line.split("}")[:-1])
                for word in line.split(" ")[1:]:
                    if len(word) > 0 and word[0].isupper() and not word in uppercase:
                        warnings.append("Capitalized word '%s' in section: %s" % (word, line))
    return warnings

def check_all(text):
    "Check stuff"

    warnings = []

    # Checks performed before stripping
    warnings += check_capitalization(text)

    # Remove newlines, whitespaces etc
    text = strip_text(text)

    # Check simple replacements
    for (a, b) in checklist:
        if a in text:
            warnings += ["%s --> %s" % (a, b)]

    # I like this line
    warnings = [warning for warning in warnings if warning is not None]

    return warnings

def strip_text(text):
    "Remove newlines, whitespaces etc"
    text = text.replace("\n", " ")
    text = text.replace("\t", " ")
    while True:
        new_text = text.replace("  ", " ")
        if len(new_text) == len(text):
            break
        text = new_text
    return text

if __name__ == "__main__":

    # Get file name
    if not len(sys.argv) == 2:
        print "Usage: proofread file.tex"
        sys.exit(1)
    filename = sys.argv[1]

    # Open file and read text
    try:
        file = open(filename)
        text = file.read()
        file.close()
    except:
        print "Unable to open file '%s'." % filename
        sys.exit(1)

    # Check stuff
    warnings = check_all(text)

    # Print results
    if len(warnings) == 0:
        s = "%s: OK" % filename
        print s + "\n" + "-"*len(s)
    else:
        s = "%s: %d warning(s)" % (filename, len(warnings))
        print s + "\n" + "-"*len(s)
        for warning in warnings:
            print "- " + warning
